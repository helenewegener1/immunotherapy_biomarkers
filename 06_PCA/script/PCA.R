setwd('~/Documents/projects/project_DGD/immunotherapy_biomarkers/')

library(tidyverse)
library(glue)
library(biomaRt)
library(GSVA)

cohorts <- readRDS('00_data/cohorts_all_allNorm.rds')
df_clinical <- readRDS('01_metadata/out/00_metadata.rds')

meta_vars <- c('Response', 'Biopsy_time', 'study', 'cancer', 'reference_genome', 'Treatment', 'Age', 'Sex', 'RECIST')

# studies <- c('Hugo_MEL', 'Riaz_MEL')
# prefix <- 'two'

# studies <- c("Auslander_MEL", "Braun_ccRCC", "Cho_NSCLC", "Choueiri_aRCC",
#              "Clouphesy_GBM", "Du_MEL", "Gide_MEL", "Hugo_MEL", "Jung_NSCLC",
#              "Kim_GC", "Liu_MEL", "Mamdani_rEAC", "Mariathasan_UC",
#              "McDermott_RCC", "Miao_ccRCC", "Motzer_aRCC", "Nathanson_MEL",
#              "Ravi_NSCLC", "Riaz_MEL", "Rose_mUC", "Snyder_UC",
#              "VanAllen_aMEL", "Vandenende_rEAC", "Zappasodi_MEL", "Zhao_GBM")
# prefix <- 'all_'

studies <- c("Auslander_MEL", "Cho_NSCLC", "Choueiri_aRCC",
             "Clouphesy_GBM", "Du_MEL", "Gide_MEL", "Hugo_MEL", "Jung_NSCLC",
             "Kim_GC", "Liu_MEL", "Mamdani_rEAC", "Mariathasan_UC",
             "McDermott_RCC", 
             "Ravi_NSCLC", "Riaz_MEL", 
             "VanAllen_aMEL", "Vandenende_rEAC", "Zappasodi_MEL", "Zhao_GBM")
prefix <- ''

###############################################################
##################### Load and merge data ##################### 
###############################################################

# df_dgd_latent_space <- data.frame() # DGD Latent space
# df_dgd_list <- list() # DGD decoder output (DGD normalization)
# 
# for (study in studies){
# 
#   # DGD Latent space
#   tmp_df <- read_csv(glue('out/{date}_{study}_representations.csv'))
#   tmp_df$study <- study
#   tmp_df$sample <- glue('{study}_{tmp_df$sample}')
# 
#   df_dgd_latent_space <- rbind(df_dgd_latent_space, tmp_df)
# 
#   rm(tmp_df)
# 
#   # DGD decoder output (DGD normalization)
#   tmp_df <- read_csv(glue('out/{date}_{study}_decoder_outputs.csv'))
#   tmp_df$study <- study
#   tmp_df$sample <- glue('{study}_{tmp_df$sample}')
# 
#   df_dgd_list[[study]] <- tmp_df
# 
#   rm(tmp_df)
# 
# }
# 
# df_dgd_latent_space
# 
# # TPM
# 
# df_tpm_list <- list() # TPM normalization
# cancer_types <- names(cohorts)
# 
# for (cancer in cancer_types){
#   
#   tmp_studies <- cohorts[[cancer]] %>% names()
#   
#   for (study in tmp_studies){
#     
#     tmp_df <- cohorts[[cancer]][[study]]$tpm %>% rownames_to_column('genes')
#     tmp_df$study <- study
#     colnames(tmp_df) <- c('genes', glue('{study}_{colnames(tmp_df)[2:(length(colnames(tmp_df))-1)]}'), 'study')
#     
#     df_tpm_list[[study]] <- tmp_df
#     
#     rm(tmp_df)
#     
#   }
#   
#   rm(tmp_studies)
#   
# }
# 
# # Subset
# df_tpm_list <- df_tpm_list[studies]

# Export 
# saveRDS(df_dgd_list, '06_PCA/out/df_dgd_list.rds')
# saveRDS(df_tpm_list, '06_PCA/out/df_tpm_list.rds')
# saveRDS(df_dgd_latent_space, '06_PCA/out/df_dgd_latent_space.rds')

df_dgd_list <- readRDS('06_PCA/out/df_dgd_list.rds')
df_tpm_list <- readRDS('06_PCA/out/df_tpm_list.rds')
df_dgd_latent_space <- readRDS('06_PCA/out/df_dgd_latent_space.rds')

###############################################################
####################### DGD Latent Space ######################
###############################################################

# Add meta data 
df_dgd_latent_space_plot <- df_dgd_latent_space %>% 
  dplyr::select(sample, latent_dim_1, latent_dim_2, latent_dim_3) %>% 
  left_join(df_clinical, by = c('sample' = 'Sample'))

for (var in meta_vars){
  
  df_dgd_latent_space_plot %>% 
    ggplot(aes(x = latent_dim_1, 
               y = latent_dim_2, 
               color = !!sym(var))) + 
    geom_point() + 
    theme_bw() + 
    labs(title = 'DGD Latent variables')
  
  ggsave(glue('06_PCA/plot/{prefix}DGD_latent_variables_{var}.png'), height = 8, width = 12)

}


###############################################################
################### PCA on DGD Latent Space ###################
###############################################################

pca_latent <- prcomp(df_dgd_latent_space %>% column_to_rownames('sample') %>% dplyr::select(!c(tissue, study)), scale. = TRUE)

# Save results in object that is ready for gg-plotting 
df_pca_latent <- pca_latent$x %>% as.data.frame() %>% 
  dplyr::select(PC1, PC2, PC3) %>% 
  rownames_to_column('sample') %>% 
  left_join(df_clinical, by = c('sample' = 'Sample'))


# Variance explained per PC
pca_latent_var_explained <- (pca_latent$sdev^2) / sum(pca_latent$sdev^2)

# Percentage explained for first 10 PCs
pca_latent_var_explained_percent <- pca_latent_var_explained[1:10] * 100

for (pair in list(c(1, 2), c(2, 3), c(1, 3))) {
  
  pc_x <- pair[1]
  pc_y <- pair[2]

  for (var in meta_vars){
    
    df_pca_latent %>% 
      ggplot(aes(x = !!sym(glue('PC{pc_x}')),
                 y = !!sym(glue('PC{pc_y}')),
                 color = !!sym(var))) + 
      geom_point() + 
      theme_bw() + 
      labs(title = 'Latent space --> PCA', 
           x = glue('PC{pc_x} ({round(pca_latent_var_explained_percent[{pc_x}], 1)}% variance explained)'),
           y = glue('PC{pc_y} ({round(pca_latent_var_explained_percent[{pc_y}], 1)}% variance explained)'))
    
    ggsave(glue('06_PCA/plot/{prefix}PCA_latent_variables_{var}_PC{pc_x}_PC{pc_y}.png'), height = 8, width = 12)
    
  }
  
}

###############################################################
################## TPM: Gene subset for PCA ################### 
###############################################################

# Extract gene vectors for each dataset in list 
gene_lists <- lapply(df_tpm_list, function(x) x$genes)

# Find intersecting genes between all datasets 
common_genes <- Reduce(intersect, gene_lists)

# Subset each dataset to the intersecting genes
datasets_common <- lapply(df_tpm_list, function(x) {
  dplyr::filter(x, genes %in% common_genes)
})

# Ensure same order of genes across datasets
datasets_common <- lapply(datasets_common, function(x) {
  x[match(common_genes, x$genes), ]
})

# Merge datasets by "genes"
merged <- Reduce(function(x, y) full_join(x, y, by = "genes"), datasets_common)

# Save meta data (study information) separately ...
metadata <- bind_rows(lapply(names(datasets_common), function(study_name) {
  tibble(
    study = study_name,
    sample = colnames(datasets_common[[study_name]])[2:(ncol(datasets_common[[study_name]]) - 1)]
  )
}))

# ... and remove study column from expression 
expr <- merged[, !colnames(merged) %>% startsWith('study')]

# Pre for PCA
expr <- expr %>% column_to_rownames('genes')
expr_t <- t(expr) # Transpose to samples (rows) × genes (columns)

# PCA with scale. = TRUE tries to standardize each column (each gene) to unit variance. 
# If a gene has zero variance across samples, I get an error.
# So, I remove zero-variance columns
expr_t_nzv <- expr_t[, apply(expr_t, 2, function(x) sd(x) > 0)]
# ncol(expr_t) - ncol(expr_t_nzv) # N genes we loose 

n_genes <- ncol(expr_t_nzv)

# run PCA
pca_tpm <- prcomp(expr_t_nzv, scale. = TRUE)

# Save results in object that is ready for gg-plotting 
df_pca_tpm <- pca_tpm$x %>% as.data.frame() %>% dplyr::select(PC1, PC2, PC3) %>% rownames_to_column('sample')

# Add meta data
df_pca_tpm <- df_pca_tpm %>% left_join(df_clinical, by = c('sample' ='Sample'))

# Variance explained per PC
pca_tpm_var_explained <- (pca_tpm$sdev^2) / sum(pca_tpm$sdev^2)

# Percentage explained for first 10 PCs
pca_tpm_var_explained_percent <- pca_tpm_var_explained[1:10] * 100

##################### Plot TPM in PC space ####################

for (var in meta_vars){
  
  for (pair in list(c(1, 2), c(2, 3), c(1, 3))) {
    pc_x <- pair[1]
    pc_y <- pair[2]

    df_pca_tpm %>%
      ggplot(aes(x = !!sym(glue('PC{pc_x}')),
                 y = !!sym(glue('PC{pc_y}')),
                 color = !!sym(var))) +
      geom_point() +
      theme_bw() +
      labs(title = 'TPM normalization --> PCA',
           subtitle = glue('N intersect genes across studies: {n_genes}'),
           x = glue('PC{pc_x} ({round(pca_tpm_var_explained_percent[{pc_x}], 1)}% variance explained)'),
           y = glue('PC{pc_y} ({round(pca_tpm_var_explained_percent[{pc_y}], 1)}% variance explained)'))

    ggsave(glue('06_PCA/plot/{prefix}PCA_TPM_{var}_PC{pc_x}_PC{pc_y}.png'), height = 8, width = 12)

  }

}

rm(n_genes)

###############################################################
########### DGD normalization: Gene subset for PCA ############ 
###############################################################

# Extract gene vectors (ignore non-gene columns)
non_gene_cols <- c("sample", "tissue", "study")
gene_lists <- lapply(df_dgd_list, function(x) {
  setdiff(colnames(x), non_gene_cols)
})

# Find intersecting genes across all datasets
common_genes <- Reduce(intersect, gene_lists)

# Subset each dataset to only the common genes + sample/tissue/study
datasets_common <- lapply(df_dgd_list, function(x) {
  x %>%
    dplyr::select(all_of(c("sample", "tissue", "study", common_genes)))
})

# datasets_common <- lapply(datasets_common, function(x) {
#   x %>%
#     dplyr::mutate(
#       sample = as.character(sample),
#       tissue = as.character(tissue),
#       study  = as.character(study)
#     )
# })

# Merge all datasets by sample, tissue, study (keeping all genes)
merged <- dplyr::bind_rows(datasets_common)

# Save sample names separately
sample <- merged %>% dplyr::select(sample) %>% unlist()

# Prepare expression matrix for PCA (only numeric gene columns)
expr <- merged %>% dplyr::select(all_of(common_genes)) %>% as.data.frame()
rownames(expr) <- sample   # keep sample names as rownames

# Transpose to samples × genes
expr_t <- as.matrix(expr)   # samples are rows, genes are columns

n_genes <- ncol(expr_t)

# Remove zero-variance genes
# expr_t_nzv <- expr_t[, apply(expr_t, 2, sd) > 0]

#  Run PCA
pca_dgd <- prcomp(expr_t, scale. = TRUE)

# Prepare PCA results for plotting
df_pca_dgd <- pca_dgd$x %>% as.data.frame() %>% dplyr::select(PC1, PC2, PC3) %>% rownames_to_column('sample')

# Add meta data
df_pca_dgd <- df_pca_dgd %>% left_join(df_clinical, by = c('sample' ='Sample'))

# Variance explained per PC
pca_dgd_var_explained <- (pca_dgd$sdev^2) / sum(pca_dgd$sdev^2)

# Percentage explained for first 10 PCs
pca_dgd_var_explained_percent <- pca_dgd_var_explained[1:10] * 100

############# Plot DGD normalization in PC space ##############

for (var in meta_vars){
  
  for (pair in list(c(1, 2), c(2, 3), c(1, 3))) {
    pc_x <- pair[1]
    pc_y <- pair[2]
  
    df_pca_dgd %>% 
      ggplot(aes(x = !!sym(glue('PC{pc_x}')),
                 y = !!sym(glue('PC{pc_y}')),
                 color = !!sym(var))) + 
      geom_point() + 
      theme_bw() + 
      labs(title = 'DGD normalization --> PCA', 
           subtitle = glue('N intersect genes across studies: {n_genes}'), 
           x = glue('PC{pc_x} ({round(pca_dgd_var_explained_percent[{pc_x}], 1)}% variance explained)'),
           y = glue('PC{pc_y} ({round(pca_dgd_var_explained_percent[{pc_y}], 1)}% variance explained)'))
    
    ggsave(glue('06_PCA/plot/{prefix}PCA_DGD_{var}_PC{pc_x}_PC{pc_y}.png'), height = 8, width = 12)
  
  }
}

rm(n_genes)

###############################################################
###################### Variance explained #####################
###############################################################

# assuming percent_explained is already computed
# barplot(pca_tpm_var_explained_percent[1:10],
#         names.arg = paste0("PC", 1:10),
#         ylab = "Variance Explained (%)",
#         xlab = "Principal Components",
#         main = "Variance Explained by Top 10 PCs")

